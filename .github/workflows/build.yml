name: Build SFML MyMineSweeper

on:
  push:
    branches: ["main"] # pushで自動実行
  workflow_dispatch: # 手動実行も許可

jobs:
  build-windows:
    # 新しく登録したランナー (C:\sfml-runner) で実行
    runs-on: self-hosted

    steps:
      # 1. コードをダウンロード
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. C++コードをコンパイル
      - name: Compile C++ Code (g++)
        # ★ 解決策1: 'bash' ではなく、Git Bash本体のフルパスを指定します
        #   (Gitのインストール先が "C:\Program Files\Git" の場合)
        shell: 'C:\Program Files\Git\bin\bash.exe -e {0}'
        run: |
          echo "Starting SFML build..."

          # --- ★ あなたのPC環境に合わせてパスを編集してください ★ ---

          # 1. (オプション) g++ へのパス
          #    (もし 'g++: command not found' が出たら、この行の # を外す)
          # export PATH="/c/msys64/ucrt64/bin:$PATH" 

          # 2. SFMLライブラリのパス (あなたのPCの絶対パス)
          SFML_INCLUDE_PATH="C:/sfml/include" # ★ あなたの環境に合わせる
          SFML_LIB_PATH="C:/sfml/lib"       # ★ あなたの環境に合わせる

          # 3. SFMLの DLL があるパス (実行に必要)
          SFML_DLL_PATH="C:/sfml/bin"       # ★ あなたの環境に合わせる

          # 4. 出力先
          OUTPUT_DIR="build"

          # --- ここから下は編集不要 ---

          # 出力先フォルダを作成
          mkdir -p $OUTPUT_DIR

          # ★ 解決策2: あなたが提示した「正解のビルドコマンド」に修正
          #    (出力先を $OUTPUT_DIR/MyMinesweeper にし、-lsfml-audio を追加)
          echo "Compiling..."
          g++ src/main.cpp src/Game.cpp src/Field.cpp src/GameUI.cpp src/GameRenderer.cpp src/SoundManager.cpp src/Solver.cpp -o $OUTPUT_DIR/MyMinesweeper -I"$SFML_INCLUDE_PATH" -L"$SFML_LIB_PATH" -lsfml-graphics -lsfml-window -lsfml-system -lsfml-audio

          # ビルド失敗時にCIを停止
          if [ $? -ne 0 ]; then
            echo "::error::Compile failed!"
            exit 1
          fi

          echo "Build finished: $OUTPUT_DIR/MyMinesweeper"

          # 6. 必要なDLLをビルドフォルダにコピー (ゲームの実行に必要)
          echo "Copying SFML DLLs..."
          cp "$SFML_DLL_PATH"/*.dll "$OUTPUT_DIR/"

          echo "DLLs copied."

      # 3. 成果物 (.exe と .dll) をzipでアップロード
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Windows-Build
          # ★ 修正: build フォルダ全体をアップロード
          path: build/
