name: Build SFML MyMineSweeper

on:
  push:
    branches: ["main"] # pushで自動実行
  workflow_dispatch: # 手動実行も許可

jobs:
  build-windows:
    # 新しく登録したランナー (C:\sfml-runner) で実行
    runs-on: self-hosted

    steps:
      # 1. コードをダウンロード
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. C++コードをコンパイル
      - name: Compile C++ Code (g++)
        # ★ shell は 'cmd' のまま
        shell: cmd

        # ★ run: の中身を、'::' (cmdのコメント) や '%' (cmdの変数) を使う
        #    以下の cmd 形式スクリプトに丸ごと差し替える
        run: |
          echo "Starting SFML build..."

          :: --- MSYS2/UCRT64 の環境に合わせてパスを修正 ---

          :: 1. g++ と SFMLのDLL がある場所へのパスを通します
          set PATH=C:\msys64\ucrt64\bin;%PATH%

          :: 2. SFMLライブラリのパス
          set SFML_INCLUDE_PATH=C:\msys64\ucrt64\include
          set SFML_LIB_PATH=C:\msys64\ucrt64\lib

          :: 3. SFMLの DLL があるパス (PATHと同じ)
          set SFML_DLL_PATH=C:\msys64\ucrt64\bin

          :: 4. コンパイル対象のソースファイル
          set SOURCE_FILES=src\main.cpp src\Game.cpp src\Field.cpp src\GameUI.cpp src\GameRenderer.cpp src\SoundManager.cpp src\Solver.cpp

          :: 5. 出力先
          set OUTPUT_DIR=build

          :: --- ここから下は編集不要 ---

          :: 出力先フォルダを作成
          mkdir %OUTPUT_DIR% 2>NUL || echo build folder already exists.

          :: g++ ビルドコマンドの実行
          echo "Compiling..."
          g++ %SOURCE_FILES% -o %OUTPUT_DIR%\MyMinesweeper.exe -I"%SFML_INCLUDE_PATH%" -L"%SFML_LIB_PATH%" -lsfml-graphics -lsfml-window -lsfml-system -lsfml-audio

          :: ビルド失敗時にCIを停止
          if %ERRORLEVEL% neq 0 (
            echo ::error::Compile failed!
            exit /b 1
          )

          echo "Build finished: %OUTPUT_DIR%\MyMinesweeper.exe"

          :: 6. 必要なDLLをビルドフォルダにコピー
          echo "Copying SFML DLLs..."

          :: ★★★ ここのファイル名パターンを修正 ★★★
          copy /Y "%SFML_DLL_PATH%\libsfml-*-2.dll" "%OUTPUT_DIR%\"

          echo "DLLs copied."

      # 3. 成果物 (.exe と .dll) をzipでアップロード
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Windows-Build
          # ★ 修正: build フォルダ全体をアップロード
          path: build/
